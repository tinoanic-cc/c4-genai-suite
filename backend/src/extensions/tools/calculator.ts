import { Calculator } from '@langchain/community/tools/calculator';
import { ChatContext, ChatMiddleware, ChatNextDelegate, GetContext } from 'src/domain/chat';
import { Extension, ExtensionSpec } from 'src/domain/extensions';
import { I18nService } from '../../localization/i18n.service';

@Extension()
export class CalculatorExtension implements Extension {
  constructor(private readonly i18n: I18nService) {}

  private readonly tool = new Calculator();

  get spec(): ExtensionSpec {
    return {
      name: 'calculator',
      title: this.i18n.t('texts.extensions.calculator.title'),
      logo: '<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 160"><path d="M50.012 119.351s3.05 12.55 2.575 14.312c-.475 1.763-9.15 3.163-14.2 5.75-3.312 1.7-8.65 5.488-5.4 8.55 1.763 1.663 6.688-2.537 21.475-3.387 15.013-.863 17.663.362 16.888-2.813-.763-3.162-4.75-3.525-8.1-4.925-1.113-.462-2.4-1.2-2.938-2-.512-.762.238-13.725.238-13.725l-10.538-1.762Z" fill="#FEBA02"/><path d="M77.7 128.149s.35 12.688.35 13.5c0 1.188-2.9 2.613-7.212 3.575-4.313.963-12.85 2.563-12.963 8.025-.075 3.363 16.4-1.187 25.813-1.05 9.412.138 15.45 1.375 15.012-2.575-.35-3.162-5.25-4.6-7.888-5.175-2.637-.575-3.837-1.862-3.912-3.437-.05-1.025.175-12.588.175-12.588l-9.375-.275Z" fill="#FEBA02"/><path d="m52.363 10.013 11.325-.763s6.3 2.038 12.287 10.713c7.95 11.537 6.9 32.637 6.9 32.637l21.825 58.188 2.638 19.237s-19.525 3.075-38.65.588c-22.525-2.938-45.75-23.35-45.4-53.85.35-30.5 24.525-59.95 24.525-59.95l4.55-6.8Z" fill="url(#a)"/><path d="M26.438 21.163s-8.688 2.7-11.15 12.438c-2.463 9.737 1.65 18.8 3.462 19.412.7.238 2.875-4.162 2.875-4.162s3.05 3.525 4.575 4.337c1.525.825 2.288 1.438 3.638 1.35 2.637-.175 6.512-7.862 6.4-13.025l1.35-25.287-11.15 4.937Z" fill="#FFD51D"/><path d="M37.312 35.113s10.588-1.762 14.813-5.4c4.225-3.637 9.15-6.925 10.787-13.487 1-4 1.05-6.8 1.05-6.8S49.2.863 35.825 7.9C22.45 14.938 25.612 24.5 25.612 24.5l11.7 10.612Z" fill="#FF2B23"/><path d="M36.875 36.526s-8.563 5.05-9.5 5.75c-.938.7-4 2.225-5.4 3.4-2.225 1.875-4.225 6.1-3.4 7.162.825 1.05 2-2.225 5.275-4.225 3.275-2 8.912-5.162 10.437-5.987 1.525-.825 2-1.288 2-1.288l.588-4.812Z" fill="#FF600D"/><path d="M39.788 34.325c.587-1.238.85-4.075-3.138-9.063-4.688-5.862-11.262-6.1-11.262-6.1l-.7 2.35 7.274 7.276L36 37.5s2.575-.625 3.788-3.175Z" fill="#A02A1B"/><path d="M19.863 25.5s5.4.35 9.15 3.638c2.225 1.95 5.587 6.125 6.412 8.012.825 1.888 3.638-3.337 1.413-6.862-2.225-3.525-4.888-7.063-9.813-8.775-3.55-1.225-6.925 1.762-7.162 3.987Z" fill="#EC80AF"/><path d="M61.862 32.425S57.525 21.4 48.6 21.863c-9 .474-10.388 7.162-9.975 11.15.475 4.612 3.525 7.162 10.563 6.925 7.05-.25 12.674-7.513 12.674-7.513Z" fill="#FBD3B3"/><path d="M55.3 31.011c0 2.85-3.1 5.4-5.925 5.4-2.813 0-5.1-2.312-5.1-5.162s1.637-5.988 5.625-6.213c4.212-.262 5.4 3.125 5.4 5.975Z" fill="#312F2A"/><path d="M107.975 100.938s2.812 6.337 13.612 13.374c9.163 5.975 13.613 9.626 19.951 11.851 6.337 2.225 6.575 2.812 6.337 3.987-.237 1.175-10.088 8.8-20.888 7.863-10.787-.938-15.95-5.163-19.237-7.388-3.288-2.225-9.5-17.95-9.5-17.95l9.725-11.737Z" fill="#01AB46"/><path d="M82.925 52.3S67.963 56.7 61.4 66.675c-5.5 8.35-5.012 22.55.587 33.088 6.925 13.024 21.238 22.287 28.863 25.812 7.625 3.525 18.062 5.275 22.637 4.812 4.575-.462-4.1-32.025-12.437-48.924C92.925 64.975 82.925 52.3 82.925 52.3Z" fill="#B7D019"/><path d="M189.888 130.025c-8.125-8.288-8.125-21.513 0-29.8L213.313 76.8c2.55-2.55 5.9-4.463 9.4-5.413 3.5-.95 7.175-.95 10.513-.162 3.5.95 6.85 2.712 9.562 5.262l.313.313c8.287 8.287 8.287 21.512 0 29.8l-23.425 23.425c-8.275 8.287-21.663 8.287-29.788 0Zm66.288-66.288c-15.45-15.45-40.788-15.45-56.25 0l-23.263 23.425c-15.45 15.45-15.45 40.788 0 56.25 15.45 15.463 40.788 15.45 56.25 0l23.425-23.425c15.288-15.462 15.288-40.787-.162-56.25Z" fill="#84B0C1"/><path d="M243.575 60.6c4.2-2.113 8.213-.638 8.213-.638-8.675-6.412-18.138-8.237-26.288-7.725-.05.063-.087.125-.137.2-3.575 5.488-4.375 12.738-2.15 18.838a21.3 21.3 0 0 1 10-.038c1.3.35 2.287.688 4.237 1.6.013-.012-.675-8.812 6.125-12.237ZM218.452 73.075c.162-1.213.237-2.438.312-3.663a76.848 76.848 0 0 1 2.675-15.612c.1-.363.2-.75.3-1.138a39.43 39.43 0 0 0-11.212 3.538c-5.55 7.162-3.725 16.437 2.787 20.612a20.928 20.928 0 0 1 5.138-3.737Z" fill="#2F7889"/><path d="M290.113 29.975c8.125 8.287 8.125 21.512 0 29.8L266.688 83.2c-2.55 2.55-5.9 4.462-9.4 5.412-3.5.95-7.175.95-10.512.163-3.5-.95-6.85-2.713-9.563-5.263l-.312-.312c-8.288-8.288-8.288-21.513 0-29.8l23.425-23.425c8.275-8.288 21.662-8.288 29.787 0Zm-66.287 66.287c15.45 15.45 40.787 15.45 56.25 0l23.262-23.425c15.45-15.45 15.45-40.787 0-56.25-15.45-15.462-40.787-15.45-56.25 0l-23.412 23.425c-15.3 15.463-15.3 40.788.15 56.25Z" fill="#84B0C1"/><path d="M223.062 49.275c.05-.038.1-.088.15-.125.662-.575 1.4-1.125 2.262-1.275.863-.15 1.875.237 2.175 1.062.225.613.025 1.288-.187 1.9-3.288 9.938-5.925 22.55-2.725 32.838.312 1 .612 2.287-.225 2.912-.488.375-1.213.313-1.75.025-5.875-3.175-6.9-11.775-7.175-17.675-.325-7.45 1.737-14.625 7.475-19.662Z" fill="#A8E3F0"/><path d="M249.152 89.175c-.8-.1-1.65-.263-1.65-.263s-.125 5.338-4.388 9.763c-4.725 4.9-9.437 4.775-9.437 4.775 2.487 1.437 7.45 2.925 9.25 3.35l.187-.188c4.788-4.8 6.788-11.25 6.038-17.437ZM273.45 76.437l-6.663 6.662c1.663 7.425 1.213 15.225-1.362 22.425a39.277 39.277 0 0 0 9.25-4.75c4.787-8.2 3.737-17.887-1.225-24.337Z" fill="#2F7889"/><path d="M259.863 87.512c-.787-1.987-2.325-4-4.25-3.812-1.2.112-3.062 1.237-2.937 4.675.087 2.662 1.1 5.262-.35 8.75-2.125 5.1-1.638 6.475-1.125 7.287.562.888 1.6 1.288 2.562 1.275 2.538-.012 4.638-2.337 5.788-4.887 1.862-4.075 1.975-9.113.312-13.288ZM221.563 135.225c.8-.662 2.875-2.875 3.837-1.475-.35 3.85-3.312 6.988-6.562 9.088-4 2.587-8.738 4.112-13.5 3.975-3.95-.113-10.5-1.713-12.8-5.375-1.875-2.975 2.087-3.488 4.287-2.663 7.838 2.988 16.7 3.05 24.738-3.55Z" fill="#A8E3F0"/><defs><linearGradient id="a" x1="58.567" y1="121.322" x2="82.322" y2="42.061" gradientUnits="userSpaceOnUse"><stop offset=".136" stop-color="#79DA88"/><stop offset=".304" stop-color="#57CD75"/><stop offset=".634" stop-color="#19B553"/><stop offset=".791" stop-color="#01AB46"/></linearGradient></defs></svg>',
      description: this.i18n.t('texts.extensions.calculator.description'),
      type: 'tool',
      arguments: {},
    };
  }

  getMiddlewares(): Promise<ChatMiddleware[]> {
    const middleware = {
      invoke: async (context: ChatContext, getContext: GetContext, next: ChatNextDelegate): Promise<any> => {
        context.tools.push(this.tool);
        return next(context);
      },
    };

    return Promise.resolve([middleware]);
  }
}
